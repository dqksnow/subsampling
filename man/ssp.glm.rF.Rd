% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/glm_rF_main_function.R
\name{ssp.glm.rF}
\alias{ssp.glm.rF}
\title{Balanced Subsampling Methods for Generalized Linear Models with Rare Features}
\usage{
ssp.glm.rF(
  formula,
  data,
  subset = NULL,
  n.plt,
  n.ssp,
  family = "binomial",
  criterion = "BL-Uni",
  sampling.method = "poisson",
  likelihood = "weighted",
  balance.plt = TRUE,
  balance.Y = FALSE,
  rareFeature.index = NULL,
  control = list(...),
  contrasts = NULL,
  ...
)
}
\arguments{
\item{formula}{A model formula object.}

\item{data}{A data frame containing the variables in the model.}

\item{subset}{An optional vector specifying a subset of observations to be
used as the full dataset.}

\item{n.plt}{The pilot sample size for computing the pilot estimator and
estimating optimal subsampling probabilities.}

\item{n.ssp}{The expected size of the optimal subsample. For
\code{sampling.method = "poisson"}, the actual sample size may vary, but the
expected size equals \code{n.ssp}.}

\item{family}{A character string naming a family. It can be a character string naming a family function, a family function or the result of a call to a family function.}

\item{criterion}{The subsampling criterion. Choices include:
\itemize{
\item \code{"BL-Uni"} (default): probabilities proportional to the balance score.
\item \code{"R-Lopt"}: rareness-aware L-optimality.
\item \code{"Aopt"}: classical A-optimality, minimizing the trace of the asymptotic
covariance matrix.
\item \code{"Lopt"}: classical L-optimality, minimizing a transformed trace of the
asymptotic covariance.
\item \code{"BL-Lopt"}: balance score combined with L-optimality.
\item \code{"Uni"}: uniform sampling with equal probabilities.
}}

\item{sampling.method}{The sampling method. Currently \code{"poisson"} is
supported, which avoids drawing repeated observations.}

\item{likelihood}{The objective function used for estimation. Currently
\code{"weighted"} is supported. Each sampled observation is weighted by the
inverse of its subsampling probability.}

\item{balance.plt}{Logical. Whether to use \code{"BL-Uni"} to draw the pilot
sample for two-step subsampling methods. Default is \code{TRUE}. A good pilot
estimator significantly improves the performance of the second-step
subsampling; a poor pilot estimator may cause failure.}

\item{balance.Y}{Logical. Whether to balance the binary response variable in
logistic regression. If \code{TRUE}, the pilot sampling probability combines the
balance score with the case-control method, and the negative subsampling will be performed for subsampling method. That is, automatically include all Y=1 observations to the subsample, while performing subsampling for Y=0 observations.}

\item{rareFeature.index}{Column indices of binary rare features in the design
matrix, coded as \code{1} for the rare case. For example,
\code{c(4, 9)} indicates that columns 4 and 9 of the design matrix contain rare
features.}

\item{control}{A list passed to \code{glm.control()}. It includes:
\itemize{
\item \code{alpha}: mixture weight between optimal and uniform probabilities, giving
\eqn{\pi = (1 - \alpha)\pi^{opt} + \alpha \pi^{uni}}.
}}

\item{contrasts}{Optional list specifying how categorical variables are
encoded in the design matrix.}

\item{...}{Additional arguments passed to \code{svyglm()}.}
}
\value{
An object of class \code{"ssp.glm.rF"} containing the following fields.

\describe{

\item{model.call}{The original function call.}

\item{coef.plt}{Pilot estimator obtained from the pilot subsample.}

\item{coef.ssp}{Estimator obtained from the optimal subsample.}

\item{coef.cmb}{Combined estimator using the union of pilot and optimal subsamples.
If \code{criterion = "BL-Uni"} or \code{"Uni"}, this equals the pilot and subsample
estimators because only one sampling step is used.}

\item{cov.plt}{Estimated covariance matrix of \code{coef.plt}.}

\item{cov.ssp}{Estimated covariance matrix of \code{coef.ssp}.}

\item{cov.cmb}{Estimated covariance matrix of \code{coef.cmb}.}

\item{N}{Number of observations in the full dataset.}

\item{subsample.size.expect}{Expected subsample size (\code{n.ssp}).}

\item{subsample.size.actual}{Actual number of subsampled observations.}

\item{full.rare.count}{Counts of each rare feature in the full dataset.}

\item{rare.count.plt}{Vector of length K giving, for each rare feature,
the number of ones in the pilot subsample.}

\item{rare.count.ssp}{Same as above, computed for the optimal subsample.}

\item{rare.count.cmb}{Same as above, computed for the combined subsample.}

\item{index.plt}{Row indices of the pilot subsample within the full dataset.}

\item{index.ssp}{Row indices of the optimal subsample within the full
dataset.}

\item{index.cmb}{Union of pilot and optimal subsample row indices.}

\item{rareFeature.index}{Column indices of rare features in the design
matrix (same as the user input).}

\item{comp.time}{Total computation time for computing sampling probabilities,
drawing subsamples, and fitting the subsample estimator.}

\item{terms}{The \code{terms} object for the fitted model.}

}
}
\description{
Rare features refer to binary covariates with low prevalence of being one
(expressed) and mostly zero. Such features create challenges for subsampling,
because naive subsampling is likely to miss these rare but informative
observations. The balanced subsampling method upweights observations that
contain expressed rare features, thereby preserving estimation efficiency for
the coefficients of rare features.

A quick start guide is provided in the vignette:
https://dqksnow.github.io/subsampling/articles/ssp-logit.html.
}
\details{
See the package vignette for more details and examples.
}
\examples{
# logistic regression
set.seed(2)
N <- 1e4
d_rare <- 3
d_cont <- 2
p_rare <- c(0.01, 0.02, 0.05)
beta0 <- c(0.5, rep(0.5, d_rare), rep(0.5, d_cont)) 
corr <- 0.5
sigmax  <- matrix(corr, d_cont, d_cont) + diag(1-corr, d_cont)
X <- MASS::mvrnorm(N, rep(0, d_cont), sigmax)
Z <- do.call(cbind, lapply(seq_along(p_rare), function(i) {
rbinom(N, 1, p_rare[i])
}))
X <- cbind(Z, X)
P <- 1 / (1 + exp(-(beta0[1] + X \%*\% beta0[-1])))
Y <- as.integer(rbinom(N, 1, P))
colnames(X) <- paste0("X", 1:(d_rare + d_cont))
rareFeature.index <- c(1:d_rare)
data <- data.frame(Y = Y, X)
formula <- Y ~ .
n.plt <- 300
n.ssp <- 2000
BL.Uni.results <- ssp.glm.rF(formula = formula, 
data = data, 
n.plt = n.plt,
n.ssp = n.ssp,
family = 'quasibinomial',
criterion = 'BL-Uni',
sampling.method = 'poisson',
likelihood = 'weighted',
balance.plt = TRUE,
balance.Y = FALSE,
rareFeature.index = rareFeature.index
)
summary(BL.Uni.results)
R.Lopt.results <- ssp.glm.rF(formula = formula, 
data = data, 
n.plt = n.plt,
n.ssp = n.ssp,
family = 'quasibinomial',
criterion = 'R-Lopt',
sampling.method = 'poisson',
likelihood = 'weighted',
balance.plt = TRUE,
balance.Y = FALSE,
rareFeature.index = rareFeature.index
)
summary(R.Lopt.results)
}
